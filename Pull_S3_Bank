import s3fs
import pandas as pd

BUCKET = "mvsgvtest"

URI = 's3://mvsgvtest/bank_credit_transactions/reconciled/08.2025.csv'
base_prefix = 'bank_credit_transactions'
fs = s3fs.S3FileSystem()


def read_periods(bucket: str, base_prefix: str, periods: list[str]) -> pd.DataFrame:

    df_list = []

    for p in periods:
        p = p.replace("/", ".")
        print(p)
        pattern = (f"s3://{bucket}/{base_prefix}/reconciled/{p}.csv")
        with fs.open(pattern, "r") as f:
            df =  pd.read_csv(f)
        df_list.append(df)

        # If no files were found, return an empty DataFrame
    if not df_list:
        print("No files were located")
        return pd.DataFrame()

    # Combine all DataFrames into one
    combined = pd.concat(df_list, ignore_index=True)
    combined.to_excel('/Users/mattray/Desktop/GV Accouting/Outputs/accounting_test_output.xlsx', index=False)


    return combined



def load_S3_data(periods,bucket=BUCKET,base_prefix= base_prefix):
    aws_df = read_periods(bucket = bucket, base_prefix=base_prefix,periods=periods)
    transactions_df = aws_df.copy()
    transactions_df = transactions_df[['date','cash_amount','credit_amount', 'description','account']]
    transactions_df['date'] = pd.to_datetime(transactions_df['date'], format="%m/%d/%y", errors='coerce')
    transactions_df['period'] = pd.to_datetime(transactions_df['date']).dt.strftime('%m/%Y')
    #### Convert to Float
    transactions_df['credit_amount'] = (
        transactions_df['credit_amount']
            .astype(str).str.replace(',', '', regex=False).str.strip()
    ).pipe(pd.to_numeric, errors='coerce').fillna(0.0)

    transactions_df['cash_amount'] = (
        transactions_df['cash_amount']
            .astype(str).str.replace(',', '', regex=False).str.strip()
    ).pipe(pd.to_numeric, errors='coerce').fillna(0.0)


    ### Fill NA
    transactions_df['cash_amount'] = transactions_df['cash_amount'].fillna(0)
    transactions_df['credit_amount'] = transactions_df['credit_amount'].fillna(0)

    return transactions_df













